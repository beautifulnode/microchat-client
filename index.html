<html> 
<head> 
    <title>Cat Chat</title> 
    <link rel="stylesheet" href="css/base.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="css/skeleton.css" type="text/css" media="screen" title="no title" charset="utf-8">
    <link rel="stylesheet" href="css/layout.css" type="text/css" media="screen" title="no title" charset="utf-8">
    
    <script src="js/AIRAliases.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/jquery-1.7.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/coffee-script.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/sugar-1.1.1.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/sproutcore.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/showdown.js" type="text/javascript" charset="utf-8"></script>
    
</head> 
<body> 
  
    <div class="container">
      <script type='text/html'>
        {{#view App.CreateMessage}}
          <textarea id='msg' autofocus placeholder='What are you doing?' style="width: 95%;margin-top: 5px;"></textarea>
          <button id="chat" style='width: 95%;'>Chat</button>          
        {{/view}}
        {{#collection contentBinding="App.messagesController" tagName="ul" }}
          <p style='margin:0;padding:0;color: green;'>{{content.author}} said <span style="color: rgba(0,0,0,.5);">{{content.fmtCreated}}</span></p>
          <div style='margin:0;padding:0;color: rgba(0,0,0,.8);'>{{{content.markdown}}}</div>        
        {{/collection}}        
      </script>
    </div>
    
    <script type="text/coffeescript"> 
      chatUrl = "http://catchat.wilbur.io/messages"

      # Get NickName
      storedValue = air.EncryptedLocalStore.getItem("nick")
      nick = storedValue.readUTFBytes(storedValue.length) if storedValue?
      
      unless nick?
        bytes = new air.ByteArray()
        bytes.writeUTFBytes(prompt('Enter your nickname:'))
        air.EncryptedLocalStore.setItem("nick", bytes) 
      
      $('title').text("CatChat - #{nick} v0.3.2")
      
      # setup SproutCore App
      window.showdown = new Showdown.converter()
      window.App = App = SC.Application.create()
      App.Author = SC.Object.extend()
      
      App.author = App.Author.create nick: nick
      
      App.Message = SC.Object.extend
        fmtCreated: ( ->
          Date.create(@get('dateCreated')).format('{Weekday} {12hr}:{mm}{tt}')
        ).property('dateCreated')
        markdown: ( ->
          # Error parsing
          #html = window.showdown.makeHtml @get('body') 
          #html or @get('body')  
          @get('body')      
        ).property('body')
      
      App.messagesController = SC.ArrayProxy.create
        content: []
        createMessage: (msg) ->
          @.unshiftObject App.Message.create(msg)
          
          
        post: (msgBody) ->
          msg = author: App.author.nick, body: msgBody
          
          request = new air.URLRequest("#{chatUrl}")
          request.method = air.URLRequestMethod.POST
          request.contentType = "application/json"
          request.data = JSON.stringify(msg)

          loader = new air.URLLoader()
          loader.load(request)
          
          msg.dateCreated = Date.create('now')
          @createMessage msg
          
        refresh: ->
          $.getJSON "#{chatUrl}?startkey=" + (10).secondBefore('now').iso(), (chats) ->  
            if chats? and chats.length > 0
              $('ul').hide()
              for chat in chats
                if chat.author != nick
                  App.messagesController.createMessage chat 
              $('ul').show('5000')
        
      App.CreateMessage = SC.View.extend
        click: ->
          msgBody = @$('textarea').val()
          App.messagesController.post msgBody
          @$('textarea').val('')

      
      $.getJSON "#{chatUrl}?limit=100", (chats) ->  
        App.messagesController.createMessage(chat) for chat in chats

      setInterval App.messagesController.refresh, 10000
      
    </script>    
</body> 
</html>